name: Test

on:
  pull_request:
  push:

jobs:
  build-type-and-test:
    name: Build Type and Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT
      - uses: actions/cache@v3
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - run: yarn install --immutable
      - name: Turbo Cache
        id: turbo-cache
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-build:type-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-build:type-
      - name: Build Type and Test
        run: yarn build:type --cache-dir=".turbo"

  build-dist:
    name: Build Dist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT
      - uses: actions/cache@v3
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - run: yarn install --immutable
      - name: Turbo Cache
        id: turbo-cache
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-build-
      - name: Type Test
        run: yarn build --cache-dir=".turbo"

  format-test:
    name: Format Test
    runs-on: ubuntu-latest
    needs: build-type-and-test
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT
      - uses: actions/cache@v3
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - run: yarn install --immutable
      - name: Turbo Cache
        id: turbo-cache
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-lint-${{ github.sha }}
      - name: Build type cache
        if: steps.turbo-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-build:type-${{ github.sha }}
      - name: Check Formatting
        run: yarn lint --cache-dir=".turbo"

  test-type-test:
    name: Test Type Test
    runs-on: ubuntu-latest
    needs: build-type-and-test
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT
      - uses: actions/cache@v3
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - run: yarn install --immutable
      - name: Turbo Cache
        id: turbo-cache
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-test:test-type-${{ github.sha }}
      - name: Build type cache
        if: steps.turbo-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-build:type-${{ github.sha }}
      - name: Test Type Test
        run: yarn test:test-type --cache-dir=".turbo"

  # Not using matrix because test later on cant needs a specific job
  client-unit-test:
    name: Client Unit Test
    needs: build-dist
    uses: ./.github/workflows/unit-test.yml
    with:
      package: client
  discordeno-unit-test:
    name: Discordeno Unit Test
    needs: build-dist
    uses: ./.github/workflows/unit-test.yml
    with:
      package: discordeno
  gateway-unit-test:
    name: Gateway Unit Test
    needs: build-dist
    uses: ./.github/workflows/unit-test.yml
    with:
      package: gateway
  rest-unit-test:
    name: Rest Unit Test
    needs: build-dist
    uses: ./.github/workflows/unit-test.yml
    with:
      package: rest
  utils-unit-test:
    name: Utils Unit Test
    needs: build-dist
    uses: ./.github/workflows/unit-test.yml
    with:
      package: utils

  #integration-test:
  #  name: Integration Test
  #  runs-on: ubuntu-latest
  #  concurrency: integration-test
  #  steps:
  #    - uses: actions/checkout@v3
  #    - uses: denoland/setup-deno@main
  #      with:
  #        deno-version: v1.x
  #    - name: Run integration
  #      # if: ${{ github.actor == 'Skillz4Killz' || github.actor == 'itohatweb' }}
  #      run: deno test --coverage=coverage -A tests/
  #      env:
  #        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
  #        UNIT_TEST_GUILD_ID: ${{ secrets.UNIT_TEST_GUILD_ID }}
  #        TEST_ENV: INTEGRATION
  #        PROXY_REST_SECRET: ${{ secrets.PROXY_REST_SECRET }}
  #        PROXY_REST_URL: ${{ secrets.PROXY_REST_URL }}
  #    - name: Create coverage report
  #      run: deno coverage --exclude=tests ./coverage --lcov > coverage.lcov
  #    - name: Collect and upload the coverage report
  #      uses: codecov/codecov-action@v3
  #      with:
  #        file: ./coverage.lcov
  #        flags: integration
